include:
  - ../common/networks.yaml

services:
  booklore:
    image: booklore/booklore:latest
    # Alternative: Use GitHub Container Registry
    # image: ghcr.io/booklore-app/booklore:latest
    container_name: booklore
    restart: unless-stopped
    environment:
      USER_ID: 1000
      GROUP_ID: 1000
      TZ: America/Los_Angeles
      DATABASE_URL: jdbc:mariadb://mariadb:3306/booklore
      DATABASE_USERNAME: booklore
      DATABASE_PASSWORD: ${MYSQL_PASSWORD}
      BOOKLORE_PORT: 6060
    expose:
      - "6060"
    depends_on:
      mariadb:
        condition: service_healthy
    volumes:
      - /opt/appdata/booklore/data:/app/data
      - type: volume
        source: central-dogma
        target: /books
        volume:
          nocopy: true
          subpath: Books
      - type: volume
        source: central-dogma
        target: /bookdrop
        volume:
          nocopy: true
          subpath: downloads/complete/book-import
    networks:
      - default
      - homelab

  mariadb:
    image: lscr.io/linuxserver/mariadb:11.4.5
    restart: unless-stopped
    environment:
      PUID: 1000
      PGID: 1000
      TZ: America/Los_Angeles
      MYSQL_DATABASE: booklore
      MYSQL_USER: booklore
      MYSQL_PASSWORD: ${MYSQL_PASSWORD}
      MYSQL_ROOT_PASSWORD: ${MYSQL_ROOT_PASSWORD}
    labels:
      docker-volume-backup.exec-label: "booklore"
      docker-volume-backup.archive-pre: /bin/sh -c 'mariadb-dump --all-databases > /backup/booklore_db.sql'
    volumes:
      - /opt/appdata/booklore/db:/config
      - /opt/appdata/booklore/db_backup:/backup
    healthcheck:
      test: [ "CMD", "mariadb-admin", "ping", "-h", "localhost" ]
      interval: 5s
      timeout: 5s
      retries: 10
    networks:
      - default

networks:
  default:
  
volumes:
  central-dogma:
    driver: local
    driver_opts:
      type: nfs
      o: addr=central-dogma.local,nolock,soft,nfsvers=4
      device: :/volume1/Media
